# discrete_active_inference (Work in progress)

Repository for active inference and behavior trees for discrete decision making. Please read the associated paper for more theorethical considerations about the algorithms.

## Dependencies
***Simulation Environment***
A singularity image can be downloaded from [here](https://drive.google.com/drive/folders/1DYuRWgCiiHCG4ck_7Pf_Kw4Kn-ZpZ-Oy?usp=sharing).

Alternatively, you can build the singularity yourself:
1. create a sub directory called 'pkgs' (in the `singularity_environment` directory)

   ```bash
      mkdir pkgs
   ```

2. use `vcstool` (or `wstool`) to clone/download the dependencies (as specified in `retail_store_lightweight_sim.repos`).

   ```bash
      vcs import < retail_store_lightweight_sim.repos pkgs
   ```

   Adding packages to `pkg` will allow `rosdep` to install all required build and run dependencies into the image, so students can then proceed to build those packages in their own workspaces (otherwise builds would fail due to missing dependencies).

   **Note**  Packages in `pkg` will be installed on the image, their source will **not** be included in the image itself, so there may be some elements that are not installed. So far I've only noticed one required change.

3. Modify the `CMakeList.txt` file from the `pal_navigation_sm` inside the `pkgs` folder.

   Change the `install` instruction (starts at line 10) by adding some scripts as follows.

   ```bash
   install(
   PROGRAMS
      scripts/map_setup.py
      scripts/pal_navigation_main_sm.py
      scripts/navigation.sh
      scripts/base_maps_symlink.sh
      scripts/cp_maps_to_home.sh
      scripts/cp_pose_to_home.sh
      DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION})
   ```

4. check the `VERSION` variable inside the `docker_build.sh`, `build.sh` and `Singularity` files. This version should match the version of your singularity install (`singularity -v`)

5. run `docker_build.sh`

   ```bash
      ./docker_build.sh
   ```

   After some time and a successful build, a new docker image will be created. This requires Docker to be installed and configured.

6. run `build.sh`

   ```bash
      ./build.sh
   ```

After some time and a successful build, a new `.simg` should be generated by `singularity` in the `cwd`.

## Using the image

After building the image, it can be `shell`ed into using the regular Singularity `shell` action:

```bash
singularity shell /path/to/ro47014-NN-XX.simg
```

where `NN-XX` is the version of the image.

Sourcing `/opt/ros/melodic/setup.bash` will also activate all the tiago dependencies installed on the image.



***Behavior trees library***
These are the steps you need to follow to be able to run these tutorials in Ubuntu. They have been tested in Ubuntu 18.04 with ROS Mlodic. 

Before proceeding, it is recommended to to install the following dependencies:

    sudo apt-get install libzmq3-dev libboost-dev

You can also easily install the [Behavior Tree library](https://github.com/BehaviorTree/BehaviorTree.CPP) with the command

    sudo apt-get install ros-$ROS_DISTRO-behaviortree-cpp-v3
    sudo apt-get update   

## Content
(Last update 01.04.2021)
This repositiry contains a Matlab example and a ros package for active inference for task planning and execution. 

### Main files 
**Matlab:**
- *aip.m* the active inference algorithm for decision making is illustrated in the case of heterogeneous states and actions. The current code shows a case with no conflicting actions, and the reactivity of the algorithm can be appreciated. The robot is unstructed to prefer to sense the door opened. In this file we only simulate what action the robot would take and we manually change the outcome just to appreciate how the agent wuld react to changing environments due to external causes. The actions are not aplied to the simulation then but only chosen to evaluate the decision making abilities. This part is implemented in *AIP_Robot_Conflicts.m*.
- *example.m* example of use of active inference for discrete decision making in a robotic case where conflicts and preconditions checks are required. A robot is assumed to be able to navigate to a point (MoveBase), reach a location with its end effector (Move MPC), and pick and place things. Actions have preconditions and are assumed not instantaneous

**ROS:**
The ROS package contains the python implementation and an example use with TIAGo (TO BE ADDED)

## How to run

Run the simulation, the perception, the decision making, and the demo:

    roslaunch retail_store_simulation tiago_simulation.launch
    rosrun discrete_ai tiago_perception.py
    rosrun discrete_ai active_inference_server.py
    rosrun discrete_ai demo_executeBT
